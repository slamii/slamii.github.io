---
layout: post
title: Docker symlink security hole
---

<p class="excerpt">On 28th May a senior software engineer Aleksa Sarai discovered a security hole within Docker which can grant an attacker read and write access to any file on the host machine regardless of its permissions.</p>

### TOCTOU

### Bug location

The vulnerability affects the `FollowSymlinkInScope` function used by many docker tools, notably `docker cp` that copies files between containers and the host machine. The purpose of `FollowSymlinkInScope` is to take a given symlink pointing to some path and safetly resolve it as though the process was inside a container.

Take for example `docker cp /path1 container1:/sym1` executed on the host. It would copy a file from `/path1` to location $\ell$ within `container1` to which `/sym1` points. $\ell$ only makes sense within the container; it does not exist on the host machine. Hence it has to be resolved to something else; to another location on the host that Docker process uses internally as `container1`'s insides.

The problem with `FollowSymlinkInScope`is that after the symlink is resolved, it is passed around a little more before it is actually used - in the case of `docker cp` to do the copying. The usage phase assumes the path is safe to use since the resolution have been done in a safely manner before.

But it can happen that an attacker adds a symlink component to the path after the resolution but before the actua use, hitting the TOCTOU window. Then the symlink will not be treated specially and can therefore point to a file on the host machine.

If used maliciously, this can give the attacker read and write permissions to any file on the host machine, even without appropriate permissions.

### Exploitation with docker cp

Aleksa provided exemplary tools to showcase the security hole on the example of `docker cp` command. We shall explain his doings.

#### Attack setup
Assume we are a regular user on the host machine with docker permissions but without root access. We want to retrieve a root-only file from the system, say `/w00t_w00t_im_a_flag`. So the first thing that Aleksa does is he creates this file, prints some unique message there and `chmod`'s it to `000` so that only root should have access to it.

Then he builds an runs a malicious container and subsequently starts an attack.

#### Container contents
The container used for the attack also contains `/w00t_w00t_im_a_flag` file with a different message to the above. The container executes a single C program which creates a symlink `/totally_safe_path` pointing to `/` as well as an empty directory. The program then atomically swaps the two in a loop until the end of time.

#### The Attack


### Fallout
Aleksa and Docker security team agreed that the public disclosure of the issue is legitimate even without a fix available.

The msot comprehensive solution to the problem would require changes to the core pieces of Docker which is not possible. Some partial solutions are underway and as for now Docker officials said that possible attack scenario is "rare/unlikely" so the flaw, while serious, is nto necessarily an emergency.

### Bibliography

1. CVE-2018-15664, Security Mailing List Archive, https://seclists.org/oss-sec/2019/q2/131
